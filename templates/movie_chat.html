{% extends "base.html" %}

{% block title %}AIËààË°åÂèéÂÖ•„Ç¢„Éä„É™„Çπ„Éà - Êò†Áîª„Éá„Éº„Çø„Éô„Éº„Çπ{% endblock %}

{% block head %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .chat-header:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: slideRight 3s infinite;
    }

    .chat-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 8px;
    }

    .chat-subtitle {
        font-size: 14px;
        opacity: 0.9;
        margin: 0 0 8px;
    }

    .analyst-info {
        font-size: 12px;
        opacity: 0.8;
        font-style: italic;
    }

    .bot-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        margin-top: 8px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-indicator.loading {
        background: #ff9800;
        animation: blink 1s infinite;
    }

    .status-indicator.error {
        background: #f44336;
        animation: none;
    }

    /* „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        scroll-behavior: smooth;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        opacity: 0;
        transform: translateY(20px);
        animation: messageIn 0.3s ease-out forwards;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .user-avatar {
        background: var(--primary-color);
        color: white;
    }

    .bot-avatar {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-weight: bold;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.5;
    }

    .user .message-content {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 6px;
    }

    .bot .message-content {
        background: white;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message-time {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        text-align: center;
    }

    /* Â∞ÇÈñÄÁöÑ„Å™ÂøúÁ≠î„Çπ„Çø„Ç§„É´ */
    .analysis-highlight {
        background: #e3f2fd;
        border-left: 4px solid #1976d2;
        padding: 12px;
        margin: 8px 0;
        border-radius: 4px;
    }

    .data-point {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 8px;
        margin: 4px 0;
        font-family: monospace;
        font-size: 13px;
    }

    /* ÂÖ•Âäõ„Ç®„É™„Ç¢ */
    .chat-input-container {
        padding: 20px;
        background: var(--card-background);
        border-top: 1px solid var(--border-color);
    }

    .chat-input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        min-height: 48px;
        max-height: 120px;
        transition: var(--transition);
        background: var(--card-background);
        color: var(--text-color);
    }

    .chat-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-button {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .send-button:hover {
        background: linear-gradient(135deg, #5a6fd8, #6a42a3);
        transform: scale(1.05);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* ÊèêÊ°àË≥™Âïè */
    .suggested-questions {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .suggestion-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        font-size: 13px;
        color: var(--text-color);
        cursor: pointer;
        transition: var(--transition);
    }

    .suggestion-btn:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
    }

    /* „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .typing-indicator.show {
        display: flex;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: typingDot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏ */
    .welcome-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .welcome-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .welcome-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .welcome-text {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .analyst-features {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
        text-align: left;
    }

    .features-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-color);
    }

    .features-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .features-list li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }

    .features-list li:last-child {
        border-bottom: none;
    }

    .features-list li:before {
        content: 'üìä';
        margin-right: 8px;
    }

    /* „Ç®„É©„ÉºË°®Á§∫ */
    .error-message {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #d32f2f;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 8px 0;
        font-size: 14px;
    }

    /* APIÁä∂ÊÖãË°®Á§∫ */
    .api-status {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 10px;
        opacity: 0.7;
    }

    .api-status.connected {
        color: #4caf50;
    }

    .api-status.disconnected {
        color: #f44336;
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 767px) {
        .chat-container {
            height: calc(100vh - 120px);
            margin: 0 -16px;
            border-radius: 0;
        }

        .chat-messages {
            padding: 16px;
        }

        .message-content {
            max-width: 85%;
        }

        .chat-input-container {
            padding: 16px;
        }

        .suggested-questions {
            justify-content: center;
        }

        .suggestion-btn {
            font-size: 12px;
            padding: 6px 10px;
        }
    }

    /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
    @media (prefers-color-scheme: dark) {
        .chat-messages {
            background: #2a2a2a;
        }

        .bot .message-content {
            background: var(--card-background);
            border-color: #555;
        }

        .suggestion-btn {
            background: var(--card-background);
            border-color: #555;
        }

        .analyst-features {
            background: var(--card-background);
        }
    }

    /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes messageIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes typingDot {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }

    @keyframes slideRight {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- „ÉÅ„É£„ÉÉ„Éà„Éò„ÉÉ„ÉÄ„Éº -->
    <div class="chat-header">
        <div class="api-status connected" id="apiStatus">GPT-4o mini Ready</div>
        <h1 class="chat-title">üé¨ AIËààË°åÂèéÂÖ•„Ç¢„Éä„É™„Çπ„Éà</h1>
        <p class="chat-subtitle">Êò†ÁîªÊ•≠Áïå„ÅÆÂ∞ÇÈñÄÂÆ∂„Åå„ÅÇ„Å™„Åü„ÅÆË≥™Âïè„Å´„ÅäÁ≠î„Åà„Åó„Åæ„Åô</p>
        <p class="analyst-info">‚Äª„Éá„Éº„Çø„Éô„Éº„ÇπÂÜÖ3000‰ΩúÂìÅ„ÅÆÊÉÖÂ†±„ÇíÊ¥ªÁî®„Åó„ÅüÂàÜÊûê„ÇíÊèê‰æõ</p>
        <div class="bot-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">„Ç™„É≥„É©„Ç§„É≥</span>
        </div>
    </div>

    <!-- „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ -->
    <div class="chat-messages" id="chatMessages">
        <div class="welcome-message" id="welcomeMessage">
            <div class="welcome-icon">üìà</div>
            <h2 class="welcome-title">Êò†ÁîªËààË°åÂèéÂÖ•Â∞ÇÈñÄ„Ç¢„Éä„É™„Çπ„Éà„Åß„Åô</h2>
            <p class="welcome-text">
                Êò†ÁîªÊ•≠Áïå„ÅÆÂãïÂêë„Åã„ÇâÂÖ∑‰ΩìÁöÑ„Å™Êï∞ÂÄ§ÂàÜÊûê„Åæ„Åß<br>
                „Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„ÅüÂ∞ÇÈñÄÁöÑ„Å™ÂõûÁ≠î„ÇíÊèê‰æõ„Åó„Åæ„Åô
            </p>
            
            <div class="analyst-features">
                <div class="features-title">üîç ÂàÜÊûêÂèØËÉΩ„Å™È†ÖÁõÆ</div>
                <ul class="features-list">
                    <li>Ê≠¥‰ª£ËààË°åÂèéÂÖ•„É©„É≥„Ç≠„É≥„Ç∞„Éª„Éà„É¨„É≥„ÉâÂàÜÊûê</li>
                    <li>„Ç¢„Éã„É°Êò†ÁîªÂ∏ÇÂ†¥„ÅÆÂãïÂêë„Å®ÊàêÂäüË¶ÅÂõ†</li>
                    <li>ÈÖçÁµ¶‰ºöÁ§æÂà•Êà¶Áï•„Éª„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞ÂàÜÊûê</li>
                    <li>SNSÊäïÁ®øÊï∞„Å®ËààË°åÂèéÂÖ•„ÅÆÁõ∏Èñ¢Èñ¢‰øÇ</li>
                    <li>Âπ¥Â∫¶Âà•„Éª„Ç∏„É£„É≥„É´Âà•Â∏ÇÂ†¥„Éá„Éº„ÇøÂàÜÊûê</li>
                    <li>Êµ∑Â§ñÊò†Áîª„ÅÆÊó•Êú¨Â∏ÇÂ†¥ÈÅ©ÂøúÊà¶Áï•</li>
                </ul>
            </div>
        </div>

        <!-- „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar bot-avatar">üìä</div>
            <div class="message-content">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- „ÉÅ„É£„ÉÉ„ÉàÂÖ•Âäõ„Ç®„É™„Ç¢ -->
    <div class="chat-input-container">
        <!-- ÊèêÊ°àË≥™Âïè -->
        <div class="suggested-questions" id="suggestedQuestions">
            <button class="suggestion-btn" onclick="sendSuggestion('È¨ºÊªÖ„ÅÆÂàÉ„ÅÆËààË°åÂèéÂÖ•404ÂÑÑÂÜÜ„ÅØ„Å™„Åú„Åù„Åì„Åæ„ÅßÊàêÂäü„Åó„Åü„ÅÆ„ÅãÂàÜÊûê„Åó„Å¶')">
                üî• È¨ºÊªÖ„ÅÆÂàÉ„ÅÆÊàêÂäüÂàÜÊûê
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('„Ç¢„Éã„É°Êò†Áîª„ÅåÊó•Êú¨„ÅßÂº∑„ÅÑÁêÜÁî±„ÇíÂ∞ÇÈñÄÁöÑ„Å´Êïô„Åà„Å¶')">
                üé® „Ç¢„Éã„É°Êò†ÁîªÂ∏ÇÂ†¥ÂàÜÊûê
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('ÊúÄËøë„ÅÆSNSÊäïÁ®øÊï∞„Å®ËààË°åÂèéÂÖ•„ÅÆÈñ¢‰øÇ„Å´„Å§„ÅÑ„Å¶')">
                üì± SNS√óËààÂèéÁõ∏Èñ¢ÂàÜÊûê
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('2024Âπ¥„ÅÆÊò†ÁîªÂ∏ÇÂ†¥ÂãïÂêë„Å®‰ªäÂæå„ÅÆ‰∫àÊ∏¨„ÇíÊïô„Åà„Å¶')">
                üìà Â∏ÇÂ†¥„Éà„É¨„É≥„Éâ‰∫àÊ∏¨
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('ÈÖçÁµ¶‰ºöÁ§æÂà•„ÅÆÊà¶Áï•„ÅÆÈÅï„ÅÑ„ÇíÂàÜÊûê„Åó„Å¶')">
                üè¢ ÈÖçÁµ¶Êà¶Áï•ÊØîËºÉ
            </button>
        </div>

        <form class="chat-input-form" id="chatForm">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="ËààË°åÂèéÂÖ•„ÇÑÊò†ÁîªÂ∏ÇÂ†¥„Å´„Å§„ÅÑ„Å¶Â∞ÇÈñÄÁöÑ„Å™Ë≥™Âïè„Çí„Å©„ÅÜ„Åû..." 
                rows="1"
                maxlength="500"></textarea>
            <button type="submit" class="send-button" id="sendButton">
                ‚û§
            </button>
        </form>
    </div>
</div>

<script>
let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let isTyping = false;
let messageCount = 0;

// DOMË¶ÅÁ¥†
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const welcomeMessage = document.getElementById('welcomeMessage');
const suggestedQuestions = document.getElementById('suggestedQuestions');
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const apiStatus = document.getElementById('apiStatus');

// „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message && !isTyping) {
        sendMessage(message);
    }
});

// „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆËá™Âãï„É™„Çµ„Ç§„Ç∫
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    
    // ÈÄÅ‰ø°„Éú„Çø„É≥„ÅÆÁä∂ÊÖã
    const hasText = this.value.trim().length > 0;
    sendButton.style.opacity = hasText ? '1' : '0.5';
    
    // ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàË°®Á§∫
    const charCount = this.value.length;
    if (charCount > 450) {
        this.style.borderColor = '#ff9800';
    } else if (charCount > 400) {
        this.style.borderColor = '#f44336';
    } else {
        this.style.borderColor = '';
    }
});

// Enter„Ç≠„Éº„ÅßÈÄÅ‰ø°ÔºàShift+Enter„ÅßÊîπË°åÔºâ
chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

// „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
function sendMessage(message) {
    if (isTyping) return;
    
    messageCount++;
    
    // „Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏„Å®ÊèêÊ°àË≥™Âïè„ÇíÈùûË°®Á§∫
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }
    if (messageCount === 1) {
        suggestedQuestions.style.display = 'none';
    }
    
    // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
    addMessage(message, 'user');
    
    // ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
    chatInput.value = '';
    chatInput.style.height = 'auto';
    sendButton.style.opacity = '0.5';
    
    // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
    showTyping();
    updateStatus('thinking', 'AIÂàÜÊûê‰∏≠...');
    
    // API„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        hideTyping();
        updateStatus('online', '„Ç™„É≥„É©„Ç§„É≥');
        
        if (data.status === 'success') {
            addMessage(data.response, 'bot');
            
            // Â∞ÇÈñÄÁöÑ„Å™ÂøúÁ≠î„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™„Çπ„Çø„Ç§„É™„É≥„Ç∞
            if (data.response.includes('ÂàÜÊûê') || data.response.includes('„Éá„Éº„Çø')) {
                addAnalysisNote();
            }
        } else {
            addMessage('Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂàÜÊûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'bot');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideTyping();
        updateStatus('error', '„Ç®„É©„Éº');
        
        let errorMessage = 'Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
        if (error.message.includes('HTTP 500')) {
            errorMessage += '„Çµ„Éº„Éê„ÉºÂÅ¥„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else if (error.message.includes('HTTP 429')) {
            errorMessage += 'API„ÅÆÂà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage += '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        } else {
            errorMessage += '‰∏ÄÊôÇÁöÑ„Å´ÂøúÁ≠î„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        }
        
        addMessage(errorMessage, 'bot');
        
        // 5ÁßíÂæå„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂæ©Êóß
        setTimeout(() => {
            updateStatus('online', '„Ç™„É≥„É©„Ç§„É≥');
        }, 5000);
    });
}

// ÊèêÊ°àË≥™Âïè„ÅÆÈÄÅ‰ø°
function sendSuggestion(message) {
    sendMessage(message);
}

// „É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${sender}-avatar`;
    avatar.textContent = sender === 'user' ? 'üë§' : 'üìä';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    // „Éú„ÉÉ„Éà„ÅÆÂøúÁ≠î„ÅßÂ∞ÇÈñÄÁî®Ë™û„Çí„Éè„Ç§„É©„Ç§„Éà
    if (sender === 'bot') {
        const formattedText = formatAnalystResponse(text);
        content.innerHTML = formattedText;
    } else {
        content.textContent = text;
    }
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date().toLocaleTimeString('ja-JP', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messageDiv.appendChild(time);
    
    chatMessages.insertBefore(messageDiv, typingIndicator);
    
    // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

// „Ç¢„Éä„É™„Çπ„ÉàÂøúÁ≠î„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
function formatAnalystResponse(text) {
    // Êï∞ÂÄ§„Çí„Éè„Ç§„É©„Ç§„Éà
    text = text.replace(/(\d+\.?\d*ÂÑÑÂÜÜ|\d+\.?\d*%)/g, '<span class="data-point">$1</span>');
    
    // ÂàÜÊûêÈ†ÖÁõÆ„Çí„Éè„Ç§„É©„Ç§„Éà
    text = text.replace(/(ÂàÜÊûê„Éù„Ç§„É≥„Éà|Ë¶ÅÂõ†|ÁâπÂæ¥|ÂÇæÂêë)Ôºö/g, '<strong>$1Ôºö</strong>');
    
    // ÁÆáÊù°Êõ∏„Åç„ÇíÊï¥ÂΩ¢
    text = text.replace(/^(\d+\.|‚Ä¢)\s*(.+)$/gm, '<div class="analysis-highlight">$1 $2</div>');
    
    // ÊîπË°å„ÇíÈÅ©Áî®
    text = text.replace(/\n/g, '<br>');
    
    return text;
}

// ÂàÜÊûê„Éé„Éº„ÉàËøΩÂä†
function addAnalysisNote() {
    const noteDiv = document.createElement('div');
    noteDiv.className = 'analysis-highlight';
    noteDiv.innerHTML = '<small>üí° „Åì„ÅÆÂàÜÊûê„ÅØÂΩì„Çµ„Ç§„Éà„ÅÆ„Éá„Éº„Çø„Éô„Éº„ÇπÔºà3000‰ΩúÂìÅ‰ª•‰∏äÔºâ„Å´Âü∫„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô</small>';
    
    const lastMessage = chatMessages.querySelector('.message.bot:last-of-type .message-content');
    if (lastMessage) {
        lastMessage.appendChild(noteDiv);
    }
}

// „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
function updateStatus(status, text) {
    statusText.textContent = text;
    statusIndicator.className = `status-indicator ${status}`;
    
    if (status === 'error') {
        apiStatus.className = 'api-status disconnected';
        apiStatus.textContent = 'API Error';
    } else if (status === 'thinking') {
        statusIndicator.className = 'status-indicator loading';
        apiStatus.className = 'api-status connected';
        apiStatus.textContent = 'GPT-4o mini Processing';
    } else {
        apiStatus.className = 'api-status connected';
                    apiStatus.textContent = 'GPT-4o mini Ready';
    }
}

// „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
function showTyping() {
    isTyping = true;
    typingIndicator.classList.add('show');
    sendButton.disabled = true;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÈùûË°®Á§∫
function hideTyping() {
    isTyping = false;
    typingIndicator.classList.remove('show');
    sendButton.disabled = false;
}

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´
    chatInput.focus();
    
    // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏
    setTimeout(() => {
        if (welcomeMessage && welcomeMessage.style.display !== 'none') {
            addMessage('„Åì„Çì„Å´„Å°„ÅØÔºÅÊò†ÁîªËààË°åÂèéÂÖ•„ÅÆÂ∞ÇÈñÄ„Ç¢„Éä„É™„Çπ„Éà„Åß„Åô„ÄÇÊ•≠Áïå„Éá„Éº„Çø„ÅÆÂàÜÊûê„ÇÑÂ∏ÇÂ†¥„Éà„É¨„É≥„Éâ„Å´„Å§„ÅÑ„Å¶„ÄÅ‰Ωï„Åß„ÇÇ„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑ„ÄÇ', 'bot');
        }
    }, 1000);
    
    // ÊèêÊ°àË≥™Âïè„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    const suggestions = document.querySelectorAll('.suggestion-btn');
    suggestions.forEach((btn, index) => {
        btn.style.opacity = '0';
        btn.style.transform = 'translateY(10px)';
        setTimeout(() => {
            btn.style.transition = 'all 0.3s ease';
            btn.style.opacity = '1';
            btn.style.transform = 'translateY(0)';
        }, 1500 + (index * 100));
    });
});

// PWAÁî®„ÅÆ„Ç™„Éï„É©„Ç§„É≥Ê§úÂá∫
window.addEventListener('online', function() {
    updateStatus('online', '„Ç™„É≥„É©„Ç§„É≥');
});

window.addEventListener('offline', function() {
    updateStatus('error', '„Ç™„Éï„É©„Ç§„É≥');
});

// ÊñáÂ≠óÊï∞Âà∂Èôê„ÅÆË≠¶Âëä
chatInput.addEventListener('input', function() {
    const charCount = this.value.length;
    const maxLength = 500;
    
    if (charCount > maxLength - 50) {
        const remaining = maxLength - charCount;
        if (remaining <= 0) {
            this.value = this.value.substring(0, maxLength);
            statusText.textContent = 'ÊñáÂ≠óÊï∞Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü';
        } else {
            statusText.textContent = `ÊÆã„Çä${remaining}ÊñáÂ≠ó`;
        }
    } else {
        if (!isTyping) {
            statusText.textContent = '„Ç™„É≥„É©„Ç§„É≥';
        }
    }
});

// „Ç®„É©„ÉºÊôÇ„ÅÆËá™ÂãïÂõûÂæ©
let errorCount = 0;
function handleError() {
    errorCount++;
    if (errorCount >= 3) {
        addMessage('‰ΩïÂ∫¶„ÇÇ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'bot');
        errorCount = 0;
    }
}

// „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆ„É≠„Éº„Ç´„É´‰øùÂ≠òÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
function saveToLocalHistory(message, sender) {
    try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        history.push({
            message,
            sender,
            timestamp: new Date().toISOString(),
            sessionId
        });
        
        // ÊúÄÊñ∞100‰ª∂„ÅÆ„Åø‰øùÊåÅ
        if (history.length > 100) {
            history.splice(0, history.length - 100);
        }
        
        localStorage.setItem('chatHistory', JSON.stringify(history));
    } catch (e) {
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
    }
}
</script>

{% endblock %}