{% extends "base.html" %}

{% block title %}æ˜ ç”»åˆ†æAIãƒãƒ£ãƒƒãƒˆ - æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹{% endblock %}

{% block head %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, var(--accent-color), #d93025);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .chat-header:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: slideRight 3s infinite;
    }

    .chat-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 8px;
    }

    .chat-subtitle {
        font-size: 14px;
        opacity: 0.9;
        margin: 0;
    }

    .bot-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        margin-top: 8px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        scroll-behavior: smooth;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        opacity: 0;
        transform: translateY(20px);
        animation: messageIn 0.3s ease-out forwards;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .user-avatar {
        background: var(--primary-color);
        color: white;
    }

    .bot-avatar {
        background: var(--accent-color);
        color: white;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }

    .user .message-content {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 6px;
    }

    .bot .message-content {
        background: white;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message-time {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        text-align: center;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .chat-input-container {
        padding: 20px;
        background: var(--card-background);
        border-top: 1px solid var(--border-color);
    }

    .chat-input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        min-height: 48px;
        max-height: 120px;
        transition: var(--transition);
        background: var(--card-background);
        color: var(--text-color);
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(234, 67, 53, 0.1);
    }

    .send-button {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        background: var(--accent-color);
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .send-button:hover {
        background: #d93025;
        transform: scale(1.05);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* ææ¡ˆè³ªå• */
    .suggested-questions {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .suggestion-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        font-size: 13px;
        color: var(--text-color);
        cursor: pointer;
        transition: var(--transition);
    }

    .suggestion-btn:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .typing-indicator.show {
        display: flex;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: typingDot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .welcome-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .welcome-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .welcome-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .welcome-text {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    /* åˆ†æãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º */
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chart-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-color);
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 767px) {
        .chat-container {
            height: calc(100vh - 120px);
            margin: 0 -16px;
            border-radius: 0;
        }

        .chat-messages {
            padding: 16px;
        }

        .message-content {
            max-width: 85%;
        }

        .chat-input-container {
            padding: 16px;
        }

        .suggested-questions {
            justify-content: center;
        }

        .suggestion-btn {
            font-size: 12px;
            padding: 6px 10px;
        }
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    @media (prefers-color-scheme: dark) {
        .chat-messages {
            background: #2a2a2a;
        }

        .bot .message-content {
            background: var(--card-background);
            border-color: #555;
        }

        .suggestion-btn {
            background: var(--card-background);
            border-color: #555;
        }

        .chart-container {
            background: var(--card-background);
        }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes messageIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes typingDot {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }

    @keyframes slideRight {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="chat-header">
        <h1 class="chat-title">ğŸ¤– æ˜ ç”»åˆ†æAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p class="chat-subtitle">æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å°‚é–€çŸ¥è­˜ã§ãŠç­”ãˆã—ã¾ã™</p>
        <div class="bot-status">
            <div class="status-indicator"></div>
            ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
    <div class="chat-messages" id="chatMessages">
        <div class="welcome-message" id="welcomeMessage">
            <div class="welcome-icon">ğŸ¬</div>
            <h2 class="welcome-title">æ˜ ç”»ã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèããã ã•ã„ï¼</h2>
            <p class="welcome-text">
                èˆˆè¡Œåå…¥ã®åˆ†æã€ãŠã™ã™ã‚æ˜ ç”»ã®ææ¡ˆã€ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ãªã©<br>
                æ˜ ç”»ã«é–¢ã™ã‚‹ã‚ã‚‰ã‚†ã‚‹è³ªå•ã«ãŠç­”ãˆã—ã¾ã™ã€‚
            </p>
        </div>

        <!-- ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar bot-avatar">ğŸ¤–</div>
            <div class="message-content">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="chat-input-container">
        <!-- ææ¡ˆè³ªå• -->
        <div class="suggested-questions" id="suggestedQuestions">
            <button class="suggestion-btn" onclick="sendSuggestion('æœ€è¿‘ã®èˆˆè¡Œåå…¥ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æ•™ãˆã¦')">
                ğŸ“ˆ æœ€è¿‘ã®ãƒˆãƒ¬ãƒ³ãƒ‰
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ã®èˆˆè¡Œåå…¥ã«ã¤ã„ã¦åˆ†æã—ã¦')">
                ğŸ¨ ã‚¢ãƒ‹ãƒ¡åˆ†æ
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('æ­´ä»£èˆˆè¡Œåå…¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ•™ãˆã¦')">
                ğŸ† æ­´ä»£ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('ãŠã™ã™ã‚ã®æ˜ ç”»ã‚’æ•™ãˆã¦')">
                â­ ãŠã™ã™ã‚
            </button>
        </div>

        <form class="chat-input-form" id="chatForm">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="æ˜ ç”»ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„..." 
                rows="1"
                maxlength="500"></textarea>
            <button type="submit" class="send-button" id="sendButton">
                â¤
            </button>
        </form>
    </div>
</div>

<script>
let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let isTyping = false;

// DOMè¦ç´ 
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const welcomeMessage = document.getElementById('welcomeMessage');
const suggestedQuestions = document.getElementById('suggestedQuestions');

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message && !isTyping) {
        sendMessage(message);
    }
});

// ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
    const hasText = this.value.trim().length > 0;
    sendButton.style.opacity = hasText ? '1' : '0.5';
});

// Enterã‚­ãƒ¼ã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
function sendMessage(message) {
    if (isTyping) return;
    
    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ææ¡ˆè³ªå•ã‚’éè¡¨ç¤º
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }
    suggestedQuestions.style.display = 'none';
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessage(message, 'user');
    
    // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
    chatInput.value = '';
    chatInput.style.height = 'auto';
    sendButton.style.opacity = '0.5';
    
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
    showTyping();
    
    // APIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTyping();
        addMessage(data.response, 'bot');
        
        // æ˜ ç”»åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
        if (data.analysis) {
            addAnalysisChart(data.analysis);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideTyping();
        addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ã«å¿œç­”ã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'bot');
    });
}

// ææ¡ˆè³ªå•ã®é€ä¿¡
function sendSuggestion(message) {
    sendMessage(message);
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${sender}-avatar`;
    avatar.textContent = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = text;
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date().toLocaleTimeString('ja-JP', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messageDiv.appendChild(time);
    
    chatMessages.insertBefore(messageDiv, typingIndicator);
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

// åˆ†æãƒãƒ£ãƒ¼ãƒˆã‚’è¿½åŠ 
function addAnalysisChart(analysisData) {
    const chartDiv = document.createElement('div');
    chartDiv.className = 'chart-container';
    
    chartDiv.innerHTML = `
        <div class="chart-title">ğŸ“Š æ˜ ç”»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</div>
        <p>æœ€è¿‘ã®èˆˆè¡Œåå…¥ãƒˆãƒƒãƒ—10ã®å¹³å‡: ${analysisData.average_revenue.toFixed(1)}å„„å††</p>
        <p>${analysisData.trend_summary}</p>
    `;
    
    chatMessages.insertBefore(chartDiv, typingIndicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
function showTyping() {
    isTyping = true;
    typingIndicator.classList.add('show');
    sendButton.disabled = true;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
function hideTyping() {
    isTyping = false;
    typingIndicator.classList.remove('show');
    sendButton.disabled = false;
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«
    chatInput.focus();
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    setTimeout(() => {
        if (welcomeMessage && welcomeMessage.style.display !== 'none') {
            addMessage('ã“ã‚“ã«ã¡ã¯ï¼æ˜ ç”»ã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèããã ã•ã„ã€‚èˆˆè¡Œåå…¥ã®åˆ†æã‚„æ˜ ç”»ã®æ¨è–¦ãªã©ã€ãŠæ‰‹ä¼ã„ã§ãã¾ã™ã€‚', 'bot');
        }
    }, 1000);
});

// PWAç”¨ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º
window.addEventListener('online', function() {
    if (document.querySelector('.bot-status')) {
        document.querySelector('.bot-status').innerHTML = `
            <div class="status-indicator"></div>
            ã‚ªãƒ³ãƒ©ã‚¤ãƒ³
        `;
    }
});

window.addEventListener('offline', function() {
    if (document.querySelector('.bot-status')) {
        document.querySelector('.bot-status').innerHTML = `
            <div class="status-indicator" style="background: #ff4444;"></div>
            ã‚ªãƒ•ãƒ©ã‚¤ãƒ³
        `;
    }
});
</script>

{% endblock %}