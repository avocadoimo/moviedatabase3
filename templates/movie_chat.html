{% extends "base.html" %}

{% block title %}AIèˆˆè¡Œåå…¥ã‚¢ãƒŠãƒªã‚¹ãƒˆ - æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹{% endblock %}

{% block head %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .chat-header:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: slideRight 3s infinite;
    }

    .chat-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 8px;
    }

    .chat-subtitle {
        font-size: 14px;
        opacity: 0.9;
        margin: 0 0 8px;
    }

    .analyst-info {
        font-size: 12px;
        opacity: 0.8;
        font-style: italic;
    }

    .bot-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        margin-top: 8px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-indicator.loading {
        background: #ff9800;
        animation: blink 1s infinite;
    }

    .status-indicator.error {
        background: #f44336;
        animation: none;
    }

    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        scroll-behavior: smooth;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        opacity: 0;
        transform: translateY(20px);
        animation: messageIn 0.3s ease-out forwards;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .user-avatar {
        background: var(--primary-color);
        color: white;
    }

    .bot-avatar {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-weight: bold;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.5;
    }

    .user .message-content {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 6px;
    }

    .bot .message-content {
        background: white;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message-time {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        text-align: center;
    }

    /* å°‚é–€çš„ãªå¿œç­”ã‚¹ã‚¿ã‚¤ãƒ« */
    .analysis-highlight {
        background: #e3f2fd;
        border-left: 4px solid #1976d2;
        padding: 12px;
        margin: 8px 0;
        border-radius: 4px;
    }

    .data-point {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 8px;
        margin: 4px 0;
        font-family: monospace;
        font-size: 13px;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .chat-input-container {
        padding: 20px;
        background: var(--card-background);
        border-top: 1px solid var(--border-color);
    }

    .chat-input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        min-height: 48px;
        max-height: 120px;
        transition: var(--transition);
        background: var(--card-background);
        color: var(--text-color);
    }

    .chat-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-button {
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .send-button:hover {
        background: linear-gradient(135deg, #5a6fd8, #6a42a3);
        transform: scale(1.05);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    /* ææ¡ˆè³ªå• */
    .suggested-questions {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .suggestion-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        font-size: 13px;
        color: var(--text-color);
        cursor: pointer;
        transition: var(--transition);
    }

    .suggestion-btn:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
    }

    /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .typing-indicator.show {
        display: flex;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: typingDot 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .welcome-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .welcome-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .welcome-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .welcome-text {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .analyst-features {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
        text-align: left;
    }

    .features-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-color);
    }

    .features-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .features-list li {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }

    .features-list li:last-child {
        border-bottom: none;
    }

    .features-list li:before {
        content: 'ğŸ“Š';
        margin-right: 8px;
    }

    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .error-message {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #d32f2f;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 8px 0;
        font-size: 14px;
    }

    /* APIçŠ¶æ…‹è¡¨ç¤º */
    .api-status {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 10px;
        opacity: 0.7;
    }

    .api-status.connected {
        color: #4caf50;
    }

    .api-status.disconnected {
        color: #f44336;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 767px) {
        .chat-container {
            height: calc(100vh - 120px);
            margin: 0 -16px;
            border-radius: 0;
        }

        .chat-messages {
            padding: 16px;
        }

        .message-content {
            max-width: 85%;
        }

        .chat-input-container {
            padding: 16px;
        }

        .suggested-questions {
            justify-content: center;
        }

        .suggestion-btn {
            font-size: 12px;
            padding: 6px 10px;
        }
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    @media (prefers-color-scheme: dark) {
        .chat-messages {
            background: #2a2a2a;
        }

        .bot .message-content {
            background: var(--card-background);
            border-color: #555;
        }

        .suggestion-btn {
            background: var(--card-background);
            border-color: #555;
        }

        .analyst-features {
            background: var(--card-background);
        }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes messageIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes typingDot {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }

    @keyframes slideRight {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="chat-header">
        <div class="api-status connected" id="apiStatus">GPT-4o mini Ready</div>
        <h1 class="chat-title">ğŸ¬ AIèˆˆè¡Œåå…¥ã‚¢ãƒŠãƒªã‚¹ãƒˆ</h1>
        <p class="chat-subtitle">æ˜ ç”»æ¥­ç•Œã®å°‚é–€å®¶ãŒã‚ãªãŸã®è³ªå•ã«ãŠç­”ãˆã—ã¾ã™</p>
        <p class="analyst-info">â€»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…3000ä½œå“ã®æƒ…å ±ã‚’æ´»ç”¨ã—ãŸåˆ†æã‚’æä¾›</p>
        <div class="bot-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
    <div class="chat-messages" id="chatMessages">
        <div class="welcome-message" id="welcomeMessage">
            <div class="welcome-icon">ğŸ“ˆ</div>
            <h2 class="welcome-title">æ˜ ç”»èˆˆè¡Œåå…¥å°‚é–€ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™</h2>
            <p class="welcome-text">
                æ˜ ç”»æ¥­ç•Œã®å‹•å‘ã‹ã‚‰å…·ä½“çš„ãªæ•°å€¤åˆ†æã¾ã§<br>
                ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå°‚é–€çš„ãªå›ç­”ã‚’æä¾›ã—ã¾ã™
            </p>
            
            <div class="analyst-features">
                <div class="features-title">ğŸ” åˆ†æå¯èƒ½ãªé …ç›®</div>
                <ul class="features-list">
                    <li>æ­´ä»£èˆˆè¡Œåå…¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</li>
                    <li>ã‚¢ãƒ‹ãƒ¡æ˜ ç”»å¸‚å ´ã®å‹•å‘ã¨æˆåŠŸè¦å› </li>
                    <li>é…çµ¦ä¼šç¤¾åˆ¥æˆ¦ç•¥ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åˆ†æ</li>
                    <li>SNSæŠ•ç¨¿æ•°ã¨èˆˆè¡Œåå…¥ã®ç›¸é–¢é–¢ä¿‚</li>
                    <li>å¹´åº¦åˆ¥ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥å¸‚å ´ãƒ‡ãƒ¼ã‚¿åˆ†æ</li>
                    <li>æµ·å¤–æ˜ ç”»ã®æ—¥æœ¬å¸‚å ´é©å¿œæˆ¦ç•¥</li>
                </ul>
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar bot-avatar">ğŸ“Š</div>
            <div class="message-content">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="chat-input-container">
        <!-- ææ¡ˆè³ªå• -->
        <div class="suggested-questions" id="suggestedQuestions">
            <button class="suggestion-btn" onclick="sendSuggestion('é¬¼æ»…ã®åˆƒã®èˆˆè¡Œåå…¥404å„„å††ã¯ãªãœãã“ã¾ã§æˆåŠŸã—ãŸã®ã‹åˆ†æã—ã¦')">
                ğŸ”¥ é¬¼æ»…ã®åˆƒã®æˆåŠŸåˆ†æ
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('ã‚¢ãƒ‹ãƒ¡æ˜ ç”»ãŒæ—¥æœ¬ã§å¼·ã„ç†ç”±ã‚’å°‚é–€çš„ã«æ•™ãˆã¦')">
                ğŸ¨ ã‚¢ãƒ‹ãƒ¡æ˜ ç”»å¸‚å ´åˆ†æ
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('æœ€è¿‘ã®SNSæŠ•ç¨¿æ•°ã¨èˆˆè¡Œåå…¥ã®é–¢ä¿‚ã«ã¤ã„ã¦')">
                ğŸ“± SNSÃ—èˆˆåç›¸é–¢åˆ†æ
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('2024å¹´ã®æ˜ ç”»å¸‚å ´å‹•å‘ã¨ä»Šå¾Œã®äºˆæ¸¬ã‚’æ•™ãˆã¦')">
                ğŸ“ˆ å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰äºˆæ¸¬
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('é…çµ¦ä¼šç¤¾åˆ¥ã®æˆ¦ç•¥ã®é•ã„ã‚’åˆ†æã—ã¦')">
                ğŸ¢ é…çµ¦æˆ¦ç•¥æ¯”è¼ƒ
            </button>
        </div>

        <form class="chat-input-form" id="chatForm">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="èˆˆè¡Œåå…¥ã‚„æ˜ ç”»å¸‚å ´ã«ã¤ã„ã¦å°‚é–€çš„ãªè³ªå•ã‚’ã©ã†ã..." 
                rows="1"
                maxlength="500"></textarea>
            <button type="submit" class="send-button" id="sendButton">
                â¤
            </button>
        </form>
    </div>
</div>

<script>
let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let isTyping = false;
let messageCount = 0;

// DOMè¦ç´ 
const chatMessages = document.getElementById('chatMessages');
const chatForm = document.getElementById('chatForm');
const chatInput = document.getElementById('chatInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const welcomeMessage = document.getElementById('welcomeMessage');
const suggestedQuestions = document.getElementById('suggestedQuestions');
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const apiStatus = document.getElementById('apiStatus');

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message && !isTyping) {
        sendMessage(message);
    }
});

// ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
    const hasText = this.value.trim().length > 0;
    sendButton.style.opacity = hasText ? '1' : '0.5';
    
    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º
    const charCount = this.value.length;
    if (charCount > 450) {
        this.style.borderColor = '#ff9800';
    } else if (charCount > 400) {
        this.style.borderColor = '#f44336';
    } else {
        this.style.borderColor = '';
    }
});

// Enterã‚­ãƒ¼ã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
function sendMessage(message) {
    if (isTyping) return;
    
    messageCount++;
    
    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ææ¡ˆè³ªå•ã‚’éè¡¨ç¤º
    if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
    }
    if (messageCount === 1) {
        suggestedQuestions.style.display = 'none';
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMessage(message, 'user');
    
    // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
    chatInput.value = '';
    chatInput.style.height = 'auto';
    sendButton.style.opacity = '0.5';
    
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
    showTyping();
    updateStatus('thinking', 'AIåˆ†æä¸­...');
    
    // APIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        hideTyping();
        updateStatus('online', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
        
        if (data.status === 'success') {
            addMessage(data.response, 'bot');
            
            // å°‚é–€çš„ãªå¿œç­”ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
            if (data.response.includes('åˆ†æ') || data.response.includes('ãƒ‡ãƒ¼ã‚¿')) {
                addAnalysisNote();
            }
        } else {
            addMessage('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'bot');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideTyping();
        updateStatus('error', 'ã‚¨ãƒ©ãƒ¼');
        
        let errorMessage = 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚';
        if (error.message.includes('HTTP 500')) {
            errorMessage += 'ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else if (error.message.includes('HTTP 429')) {
            errorMessage += 'APIã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else {
            errorMessage += 'ä¸€æ™‚çš„ã«å¿œç­”ã§ãã¾ã›ã‚“ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        
        addMessage(errorMessage, 'bot');
        
        // 5ç§’å¾Œã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¾©æ—§
        setTimeout(() => {
            updateStatus('online', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
        }, 5000);
    });
}

// ææ¡ˆè³ªå•ã®é€ä¿¡
function sendSuggestion(message) {
    sendMessage(message);
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${sender}-avatar`;
    avatar.textContent = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ“Š';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    // ãƒœãƒƒãƒˆã®å¿œç­”ã§å°‚é–€ç”¨èªã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    if (sender === 'bot') {
        const formattedText = formatAnalystResponse(text);
        content.innerHTML = formattedText;
    } else {
        content.textContent = text;
    }
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date().toLocaleTimeString('ja-JP', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    messageDiv.appendChild(time);
    
    chatMessages.insertBefore(messageDiv, typingIndicator);
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

// ã‚¢ãƒŠãƒªã‚¹ãƒˆå¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatAnalystResponse(text) {
    // æ•°å€¤ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    text = text.replace(/(\d+\.?\d*å„„å††|\d+\.?\d*%)/g, '<span class="data-point">$1</span>');
    
    // åˆ†æé …ç›®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    text = text.replace(/(åˆ†æãƒã‚¤ãƒ³ãƒˆ|è¦å› |ç‰¹å¾´|å‚¾å‘)ï¼š/g, '<strong>$1ï¼š</strong>');
    
    // ç®‡æ¡æ›¸ãã‚’æ•´å½¢
    text = text.replace(/^(\d+\.|â€¢)\s*(.+)$/gm, '<div class="analysis-highlight">$1 $2</div>');
    
    // æ”¹è¡Œã‚’é©ç”¨
    text = text.replace(/\n/g, '<br>');
    
    return text;
}

// åˆ†æãƒãƒ¼ãƒˆè¿½åŠ 
function addAnalysisNote() {
    const noteDiv = document.createElement('div');
    noteDiv.className = 'analysis-highlight';
    noteDiv.innerHTML = '<small>ğŸ’¡ ã“ã®åˆ†æã¯å½“ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆ3000ä½œå“ä»¥ä¸Šï¼‰ã«åŸºã¥ã„ã¦ã„ã¾ã™</small>';
    
    const lastMessage = chatMessages.querySelector('.message.bot:last-of-type .message-content');
    if (lastMessage) {
        lastMessage.appendChild(noteDiv);
    }
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateStatus(status, text) {
    statusText.textContent = text;
    statusIndicator.className = `status-indicator ${status}`;
    
    if (status === 'error') {
        apiStatus.className = 'api-status disconnected';
        apiStatus.textContent = 'API Error';
    } else if (status === 'thinking') {
        statusIndicator.className = 'status-indicator loading';
        apiStatus.className = 'api-status connected';
        apiStatus.textContent = 'GPT-4o mini Processing';
    } else {
        apiStatus.className = 'api-status connected';
                    apiStatus.textContent = 'GPT-4o mini Ready';
    }
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
function showTyping() {
    isTyping = true;
    typingIndicator.classList.add('show');
    sendButton.disabled = true;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼éè¡¨ç¤º
function hideTyping() {
    isTyping = false;
    typingIndicator.classList.remove('show');
    sendButton.disabled = false;
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«
    chatInput.focus();
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    setTimeout(() => {
        if (welcomeMessage && welcomeMessage.style.display !== 'none') {
            addMessage('ã“ã‚“ã«ã¡ã¯ï¼æ˜ ç”»èˆˆè¡Œåå…¥ã®å°‚é–€ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚æ¥­ç•Œãƒ‡ãƒ¼ã‚¿ã®åˆ†æã‚„å¸‚å ´ãƒˆãƒ¬ãƒ³ãƒ‰ã«ã¤ã„ã¦ã€ä½•ã§ã‚‚ãŠèããã ã•ã„ã€‚', 'bot');
        }
    }, 1000);
    
    // ææ¡ˆè³ªå•ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const suggestions = document.querySelectorAll('.suggestion-btn');
    suggestions.forEach((btn, index) => {
        btn.style.opacity = '0';
        btn.style.transform = 'translateY(10px)';
        setTimeout(() => {
            btn.style.transition = 'all 0.3s ease';
            btn.style.opacity = '1';
            btn.style.transform = 'translateY(0)';
        }, 1500 + (index * 100));
    });
});

// PWAç”¨ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º
window.addEventListener('online', function() {
    updateStatus('online', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³');
});

window.addEventListener('offline', function() {
    updateStatus('error', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
});

// æ–‡å­—æ•°åˆ¶é™ã®è­¦å‘Š
chatInput.addEventListener('input', function() {
    const charCount = this.value.length;
    const maxLength = 500;
    
    if (charCount > maxLength - 50) {
        const remaining = maxLength - charCount;
        if (remaining <= 0) {
            this.value = this.value.substring(0, maxLength);
            statusText.textContent = 'æ–‡å­—æ•°åˆ¶é™ã«é”ã—ã¾ã—ãŸ';
        } else {
            statusText.textContent = `æ®‹ã‚Š${remaining}æ–‡å­—`;
        }
    } else {
        if (!isTyping) {
            statusText.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
        }
    }
});

// ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å›å¾©
let errorCount = 0;
function handleError() {
    errorCount++;
    if (errorCount >= 3) {
        addMessage('ä½•åº¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'bot');
        errorCount = 0;
    }
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
function saveToLocalHistory(message, sender) {
    try {
        const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        history.push({
            message,
            sender,
            timestamp: new Date().toISOString(),
            sessionId
        });
        
        // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
        if (history.length > 100) {
            history.splice(0, history.length - 100);
        }
        
        localStorage.setItem('chatHistory', JSON.stringify(history));
    } catch (e) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    }
}
</script>

{% endblock %}