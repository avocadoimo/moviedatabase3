{% extends "base.html" %}

{% block title %}{{ movie.title }} - 映画データベース{% endblock %}

{% block head %}
<style>
    .movie-detail-card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        padding: 30px;
        margin: auto;
        max-width: 800px;
    }

    .poster-img {
        display: block;
        max-width: 300px;
        height: auto;
        margin: 0 auto 20px;
        border-radius: 8px;
        box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }

    .section {
        margin-bottom: 20px;
    }

    .section h2 {
        margin: 0 0 5px;
        font-size: 1.1em;
        color: #333;
    }

    .section p {
        margin: 0;
        line-height: 1.6;
        color: #444;
    }

    .copyright {
        font-size: 0.8em;
        color: #777;
        margin-top: 10px;
        text-align: center;
    }

    .back-button {
        display: inline-block;
        margin-bottom: 20px;
        padding: 6px 14px;
        background-color: #1a73e8;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9em;
    }

    .back-button:hover {
        background-color: #1558b0;
    }

    /* リンク付きアイテムのスタイル */
    .clickable-item {
        color: #1a73e8;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .clickable-item:hover {
        color: #1558b0;
        text-decoration: underline;
    }

    /* セクションの視覚的改善 */
    .section {
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .section:last-child {
        border-bottom: none;
    }

    .section h2 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1em;
        color: #333;
        margin-bottom: 8px;
    }

    .section-icon {
        font-size: 1.2em;
    }

    /* レスポンシブ対応 */
    @media (max-width: 767px) {
        .movie-detail-card {
            padding: 20px;
        }

        .poster-img {
            max-width: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="movie-detail-card">

    <a class="back-button" href="{{ url_for('search') }}">← ホームへ戻る</a>

    <h1 style="text-align: center;">{{ movie.title }}</h1>

    {% if movie.movie_id %}
        <img class="poster-img" src="{{ url_for('static', filename='posters/' ~ movie.movie_id|string ~ '.jpg') }}" alt="ポスター画像">
    {% else %}
        <p style="text-align: center;">ポスター画像がありません</p>
    {% endif %}

    {% if movie.copyright %}
        <div class="copyright">{{ movie.copyright }}</div>
    {% endif %}

    <div class="section">
        <h2>公開日</h2>
        <p>{{ movie.release_date or '情報なし' }}</p>
    </div>

    <!-- 興行収入セクション -->
    <div class="section" id="revenueSection" style="display: none;">
        <h2>興行収入</h2>
        <p id="revenueContent">{{ movie.revenue }}億円</p>
    </div>

    <div class="section">
        <h2>配給会社</h2>
        <p>
            {% if movie.distributor %}
                {% for dist in movie.distributor.split('、') %}
                    <a href="{{ url_for('search', distributor=dist.strip()) }}" class="clickable-item">{{ dist.strip() }}</a>{% if not loop.last %}、{% endif %}
                {% endfor %}
            {% else %}
                情報なし
            {% endif %}
        </p>
    </div>

    <!-- ジャンル情報 -->
    {% if movie.genre %}
    <div class="section">
        <h2>ジャンル</h2>
        <p>
            {% for genre_item in movie.genre.split(',') %}
                <a href="{{ url_for('search', genre=genre_item.strip()) }}" class="clickable-item">{{ genre_item.strip() }}</a>{% if not loop.last %}、{% endif %}
            {% endfor %}
        </p>
    </div>
    {% endif %}

    <div class="section">
        <h2>あらすじ</h2>
        <p>{{ movie.description or '情報なし' }}</p>
    </div>

    {% if movie.director %}
    <div class="section">
        <h2>監督</h2>
        <p><a href="{{ url_for('search', director=movie.director) }}" class="clickable-item">{{ movie.director }}</a></p>
    </div>
    {% endif %}

    {% if movie.scriptwriter %}
    <div class="section">
        <h2>脚本</h2>
        <p><a href="{{ url_for('search', scriptwriter=movie.scriptwriter) }}" class="clickable-item">{{ movie.scriptwriter }}</a></p>
    </div>
    {% endif %}

    {% if movie.author %}
    <div class="section">
        <h2>原作</h2>
        <p>{{ movie.author }}</p>
    </div>
    {% endif %}

    {% if movie.producer %}
    <div class="section">
        <h2>プロデューサー</h2>
        <p><a href="{{ url_for('search', producer=movie.producer) }}" class="clickable-item">{{ movie.producer }}</a></p>
    </div>
    {% endif %}

    {% if movie.actor %}
    <div class="section">
        <h2>キャスト</h2>
        <p>
            {% for actor in movie.actor.split(',') %}
                <a href="{{ url_for('search', actor=actor.strip()) }}" class="clickable-item">{{ actor.strip() }}</a>{% if not loop.last %}、{% endif %}
            {% endfor %}
        </p>
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 興収推移データの存在確認
        const movieId = {{ movie.id }};
        const revenueSection = document.getElementById('revenueSection');
        const revenueContent = document.getElementById('revenueContent');
        
        if (revenueSection && revenueContent) {
            // 興収推移データの存在確認API呼び出し
            fetch(`/api/box-office-check/${movieId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.has_data) {
                        // データがある場合：「○○億円→詳細データ」を表示
                        revenueContent.innerHTML = `{{ movie.revenue }}億円→<a href="{{ url_for('box_office_detail', movie_id=movie.id) }}" class="clickable-item">詳細データ</a>`;
                        revenueSection.style.display = 'block';
                    }
                    // データがない場合は何も表示しない（デフォルトでdisplay: none）
                })
                .catch(error => {
                    console.error('興収推移データ確認エラー:', error);
                    // エラーの場合は表示しない
                });
        }
    });

    window.addEventListener("load", function() {
        window.scrollTo(0, 165);  // ← ページ読み込み直後に200px下にピタッと表示
    });

    // アクセシビリティ改善：キーボードナビゲーション
    document.querySelectorAll('.clickable-item').forEach(element => {
        element.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
        element.setAttribute('tabindex', '0');
    });
</script>

{% endblock %}