{% extends "base.html" %}

{% block title %}
{% if article %}Ë®ò‰∫ãÁ∑®ÈõÜÔºàÂº∑ÂåñÁâàÔºâ{% else %}Êñ∞Ë¶èË®ò‰∫ã‰ΩúÊàêÔºàÂº∑ÂåñÁâàÔºâ{% endif %} - Êò†Áîª„Éá„Éº„Çø„Éô„Éº„Çπ
{% endblock %}

{% block head %}
<style>
    .admin-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: var(--card-background);
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    .admin-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-success {
        background: var(--secondary-color);
        color: white;
    }

    .article-form {
        background: var(--card-background);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 30px;
    }

    .form-grid {
        display: grid;
        gap: 24px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
        box-sizing: border-box;
        font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    /* „É™„ÉÉ„ÉÅ„ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø */
    .rich-editor-container {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .rich-editor-toolbar {
        background: #f8f9fa;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .toolbar-btn {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .toolbar-btn:hover {
        background: #e9ecef;
    }

    .toolbar-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .toolbar-separator {
        width: 1px;
        background: #ddd;
        margin: 0 4px;
    }

    .rich-editor {
        min-height: 400px;
        padding: 16px;
        outline: none;
        font-size: 16px;
        line-height: 1.6;
        color: var(--text-color);
    }

    .rich-editor:focus {
        background: #fafbfc;
    }

    /* ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ */
    .image-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafbfc;
    }

    .image-upload-area:hover {
        border-color: var(--primary-color);
        background: #f0f7ff;
    }

    .image-upload-area.dragover {
        border-color: var(--primary-color);
        background: #e3f2fd;
    }

    .upload-icon {
        font-size: 48px;
        color: #999;
        margin-bottom: 16px;
    }

    .upload-text {
        font-size: 16px;
        color: #666;
        margin-bottom: 8px;
    }

    .upload-hint {
        font-size: 14px;
        color: #999;
    }

    /* „Çµ„É†„Éç„Ç§„É´Ë®≠ÂÆö */
    .thumbnail-section {
        display: grid;
        grid-template-columns: 1fr 200px;
        gap: 20px;
        align-items: start;
    }

    .thumbnail-preview {
        width: 200px;
        height: 120px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        position: relative;
        overflow: hidden;
    }

    .thumbnail-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .thumbnail-placeholder {
        color: #999;
        font-size: 14px;
        text-align: center;
    }

    .thumbnail-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(244, 67, 54, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
    }

    /* „É°„Éá„Ç£„Ç¢ÊåøÂÖ•„É¢„Éº„ÉÄ„É´ */
    .media-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .media-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }

    .modal-tabs {
        display: flex;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }

    .modal-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        border-bottom: 2px solid transparent;
    }

    .modal-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* „É™„É≥„ÇØÊåøÂÖ• */
    .link-section {
        display: grid;
        gap: 16px;
    }

    .movie-search-container {
        position: relative;
    }

    .movie-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
    }

    .movie-suggestion {
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
    }

    .movie-suggestion:hover {
        background: #f8f9fa;
    }

    .suggestion-revenue {
        font-size: 12px;
        color: #666;
    }

    /* „Éï„Ç©„Éº„É†„Ç¢„ÇØ„Ç∑„Éß„É≥ */
    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .error-message {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #d32f2f;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
    @media (max-width: 767px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .thumbnail-section {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }

        .rich-editor-toolbar {
            padding: 8px;
            gap: 4px;
        }

        .toolbar-btn {
            padding: 4px 8px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">
            {% if article %}‚úèÔ∏è Ë®ò‰∫ãÁ∑®ÈõÜÔºàÂº∑ÂåñÁâàÔºâ{% else %}‚ûï Êñ∞Ë¶èË®ò‰∫ã‰ΩúÊàêÔºàÂº∑ÂåñÁâàÔºâ{% endif %}
        </h1>
        <div class="admin-actions">
            <a href="{{ url_for('admin_articles') }}" class="btn btn-primary">
                üìã Ë®ò‰∫ã‰∏ÄË¶ß„Å´Êàª„Çã
            </a>
        </div>
    </div>

    {% if error %}
    <div class="error-message">
        {{ error }}
    </div>
    {% endif %}

    <form method="post" class="article-form" enctype="multipart/form-data">
        <div class="form-grid">
            <!-- „Çø„Ç§„Éà„É´ -->
            <div class="form-group">
                <label class="form-label" for="title">Ë®ò‰∫ã„Çø„Ç§„Éà„É´ *</label>
                <input type="text" id="title" name="title" class="form-input" 
                       value="{{ article.title if article else (form_data.title if form_data else '') }}" 
                       required placeholder="Êò†Áîª„Å´Èñ¢„Åô„ÇãË®ò‰∫ã„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
            </div>

            <!-- Âü∫Êú¨ÊÉÖÂ†± -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="author">‰ΩúÊàêËÄÖ</label>
                    <input type="text" id="author" name="author" class="form-input" 
                           value="{{ article.author if article else (form_data.author if form_data else '') }}" 
                           placeholder="Ë®ò‰∫ã„ÅÆ‰ΩúÊàêËÄÖÂêç">
                </div>

                <div class="form-group">
                    <label class="form-label" for="category">„Ç´„ÉÜ„Ç¥„É™</label>
                    <select id="category" name="category" class="form-select">
                        <option value="">„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" 
                                {% if article and article.category == cat %}selected{% endif %}
                                {% if form_data and form_data.category == cat %}selected{% endif %}>
                            {{ cat }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- „Çµ„É†„Éç„Ç§„É´Ë®≠ÂÆö -->
            <div class="form-group">
                <label class="form-label">„Çµ„É†„Éç„Ç§„É´ÁîªÂÉè</label>
                <div class="thumbnail-section">
                    <div>
                        <input type="url" id="thumbnail_url" name="thumbnail_url" class="form-input" 
                               value="{{ article.thumbnail_url if article else (form_data.thumbnail_url if form_data else '') }}" 
                               placeholder="ÁîªÂÉèURL„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅ‰∏ã„ÅÆ„Ç®„É™„Ç¢„Å´ÁîªÂÉè„Çí„Éâ„É≠„ÉÉ„Éó">
                        <div class="image-upload-area" id="thumbnailUpload">
                            <div class="upload-icon">üì∑</div>
                            <div class="upload-text">ÁîªÂÉè„Çí„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</div>
                            <div class="upload-hint">JPG, PNG, GIF (ÊúÄÂ§ß5MB)</div>
                        </div>
                    </div>
                    <div class="thumbnail-preview" id="thumbnailPreview">
                        {% if article and article.thumbnail_url %}
                            <img src="{{ article.thumbnail_url }}" alt="„Çµ„É†„Éç„Ç§„É´">
                            <button type="button" class="thumbnail-remove" onclick="removeThumbnail()">√ó</button>
                        {% else %}
                            <div class="thumbnail-placeholder">
                                <div>„Éó„É¨„Éì„É•„Éº</div>
                                <div style="font-size: 12px;">200√ó120</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Ë®ò‰∫ã„ÅÆÊäúÁ≤ã -->
            <div class="form-group">
                <label class="form-label" for="excerpt">Ë®ò‰∫ã„ÅÆÊäúÁ≤ã</label>
                <textarea id="excerpt" name="excerpt" class="form-textarea" 
                          placeholder="Ë®ò‰∫ã„ÅÆË¶ÅÁ¥Ñ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÁ©∫ÁôΩ„ÅÆÂ†¥Âêà„ÅØËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„ÅôÔºâ">{{ article.excerpt if article else (form_data.excerpt if form_data else '') }}</textarea>
            </div>

            <!-- „É™„ÉÉ„ÉÅ„ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø -->
            <div class="form-group">
                <label class="form-label" for="content">Ë®ò‰∫ãÂÜÖÂÆπ *</label>
                
                <!-- „ÉÑ„Éº„É´„Éê„Éº -->
                <div class="rich-editor-container">
                    <div class="rich-editor-toolbar">
                        <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Â§™Â≠ó">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Êñú‰Ωì">
                            <em>I</em>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="‰∏ãÁ∑ö">
                            <u>U</u>
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button type="button" class="toolbar-btn" onclick="formatText('formatBlock', 'h2')" title="Ë¶ãÂá∫„Åó2">
                            H2
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('formatBlock', 'h3')" title="Ë¶ãÂá∫„Åó3">
                            H3
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('formatBlock', 'p')" title="ÊÆµËêΩ">
                            P
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button type="button" class="toolbar-btn" onclick="insertList('ul')" title="ÁÆáÊù°Êõ∏„Åç">
                            ‚óè
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertList('ol')" title="Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà">
                            1.
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button type="button" class="toolbar-btn" onclick="openMediaModal('image')" title="ÁîªÂÉèÊåøÂÖ•">
                            üì∑
                        </button>
                        <button type="button" class="toolbar-btn" onclick="openMediaModal('video')" title="ÂãïÁîªÊåøÂÖ•">
                            üé¨
                        </button>
                        <button type="button" class="toolbar-btn" onclick="openMediaModal('link')" title="„É™„É≥„ÇØÊåøÂÖ•">
                            üîó
                        </button>
                    </div>
                    
                    <!-- „Ç®„Éá„Ç£„ÇøÊú¨‰Ωì -->
                    <div id="richEditor" class="rich-editor" contenteditable="true">
                        {{ article.content_html if article and article.content_html else (article.content.replace('\n', '<br>') if article else '') }}
                    </div>
                </div>
                
                <!-- Èö†„Åó„Éï„Ç£„Éº„É´„Éâ -->
                <textarea id="content" name="content" style="display: none;" required>{{ article.content if article else (form_data.content if form_data else '') }}</textarea>
                <textarea id="content_html" name="content_html" style="display: none;">{{ article.content_html if article else (form_data.content_html if form_data else '') }}</textarea>
            </div>

            <!-- „Çø„Ç∞ -->
            <div class="form-group">
                <label class="form-label" for="tags">„Çø„Ç∞</label>
                <input type="text" id="tags" name="tags" class="form-input" 
                       value="{{ article.tags if article else (form_data.tags if form_data else '') }}" 
                       placeholder="„Çø„Ç∞„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÂÖ•ÂäõÔºà‰æã: „Ç¢„Éã„É°,ËààË°åÂèéÂÖ•,„Éà„É¨„É≥„ÉâÔºâ">
            </div>

            <!-- Ê≥®ÁõÆË®ò‰∫ãË®≠ÂÆö -->
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="is_featured" name="is_featured" 
                           {% if article and article.is_featured %}checked{% endif %}
                           {% if form_data and form_data.is_featured %}checked{% endif %}>
                    ‚≠ê Ê≥®ÁõÆË®ò‰∫ã„Å®„Åó„Å¶Ë°®Á§∫„Åô„Çã
                </label>
            </div>

            <!-- „Éï„Ç©„Éº„É†„Ç¢„ÇØ„Ç∑„Éß„É≥ -->
            <div class="form-actions">
                <a href="{{ url_for('admin_articles') }}" class="btn" style="background: #666; color: white;">
                    „Ç≠„É£„É≥„Çª„É´
                </a>
                <button type="submit" class="btn btn-success">
                    {% if article %}üíæ Ë®ò‰∫ã„ÇíÊõ¥Êñ∞{% else %}üìù Ë®ò‰∫ã„Çí‰ΩúÊàê{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- „É°„Éá„Ç£„Ç¢ÊåøÂÖ•„É¢„Éº„ÉÄ„É´ -->
<div id="mediaModal" class="media-modal">
    <div class="media-modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">„É°„Éá„Ç£„Ç¢„ÇíÊåøÂÖ•</h3>
            <button type="button" class="modal-close" onclick="closeMediaModal()">√ó</button>
        </div>
        
        <div class="modal-tabs">
            <button type="button" class="modal-tab active" onclick="switchTab('image')">ÁîªÂÉè</button>
            <button type="button" class="modal-tab" onclick="switchTab('video')">ÂãïÁîª</button>
            <button type="button" class="modal-tab" onclick="switchTab('link')">„É™„É≥„ÇØ</button>
        </div>
        
        <!-- ÁîªÂÉèÊåøÂÖ•„Çø„Éñ -->
        <div id="imageTab" class="tab-content active">
            <div class="form-group">
                <label class="form-label">ÁîªÂÉèURL</label>
                <input type="url" id="imageUrl" class="form-input" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label class="form-label">‰ª£Êõø„ÉÜ„Ç≠„Çπ„Éà</label>
                <input type="text" id="imageAlt" class="form-input" placeholder="ÁîªÂÉè„ÅÆË™¨Êòé">
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn btn-primary" onclick="insertImage()">ÁîªÂÉè„ÇíÊåøÂÖ•</button>
            </div>
        </div>
        
        <!-- ÂãïÁîªÊåøÂÖ•„Çø„Éñ -->
        <div id="videoTab" class="tab-content">
            <div class="form-group">
                <label class="form-label">YouTube URL</label>
                <input type="url" id="youtubeUrl" class="form-input" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label class="form-label">Twitter/X „Éù„Çπ„ÉàURL</label>
                <input type="url" id="twitterUrl" class="form-input" placeholder="https://twitter.com/user/status/...">
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn btn-primary" onclick="insertVideo()">ÂãïÁîª„ÇíÊåøÂÖ•</button>
            </div>
        </div>
        
        <!-- „É™„É≥„ÇØÊåøÂÖ•„Çø„Éñ -->
        <div id="linkTab" class="tab-content">
            <div class="form-group">
                <label class="form-label">„É™„É≥„ÇØÁ®ÆÂà•</label>
                <select id="linkType" class="form-select" onchange="toggleLinkOptions()">
                    <option value="external">Â§ñÈÉ®„É™„É≥„ÇØ</option>
                    <option value="movie">‰ΩúÂìÅË©≥Á¥∞„Éö„Éº„Ç∏</option>
                    <option value="article">Ë®ò‰∫ã„Éö„Éº„Ç∏</option>
                </select>
            </div>
            
            <!-- Â§ñÈÉ®„É™„É≥„ÇØ -->
            <div id="externalLinkGroup">
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" id="externalUrl" class="form-input" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà</label>
                    <input type="text" id="linkText" class="form-input" placeholder="„É™„É≥„ÇØ„Å´Ë°®Á§∫„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà">
                </div>
            </div>
            
            <!-- ‰ΩúÂìÅ„É™„É≥„ÇØ -->
            <div id="movieLinkGroup" style="display: none;">
                <div class="form-group">
                    <label class="form-label">‰ΩúÂìÅ„ÇíÊ§úÁ¥¢</label>
                    <div class="movie-search-container">
                        <input type="text" id="movieSearch" class="form-input" placeholder="Êò†Áîª„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ" autocomplete="off">
                        <div id="movieSuggestions" class="movie-suggestions"></div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: right;">
                <button type="button" class="btn btn-primary" onclick="insertLink()">„É™„É≥„ÇØ„ÇíÊåøÂÖ•</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedMovieId = null;

// „É™„ÉÉ„ÉÅ„ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø„ÅÆÊ©üËÉΩ
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    updateHiddenFields();
}

function insertList(type) {
    const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
    document.execCommand(command, false, null);
    updateHiddenFields();
}

// „Ç®„Éá„Ç£„ÇøÂÜÖÂÆπ„ÅÆÊõ¥Êñ∞
function updateHiddenFields() {
    const editor = document.getElementById('richEditor');
    const htmlContent = editor.innerHTML;
    const textContent = editor.innerText;
    
    document.getElementById('content_html').value = htmlContent;
    document.getElementById('content').value = textContent;
}

// „Ç®„Éá„Ç£„Çø„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
document.getElementById('richEditor').addEventListener('input', updateHiddenFields);
document.getElementById('richEditor').addEventListener('paste', function(e) {
    setTimeout(updateHiddenFields, 100);
});

// „É°„Éá„Ç£„Ç¢„É¢„Éº„ÉÄ„É´
function openMediaModal(type) {
    document.getElementById('mediaModal').style.display = 'block';
    switchTab(type);
    
    const titles = {
        'image': 'ÁîªÂÉè„ÇíÊåøÂÖ•',
        'video': 'ÂãïÁîª„ÇíÊåøÂÖ•', 
        'link': '„É™„É≥„ÇØ„ÇíÊåøÂÖ•'
    };
    
    document.getElementById('modalTitle').textContent = titles[type] || '„É°„Éá„Ç£„Ç¢„ÇíÊåøÂÖ•';
}

function closeMediaModal() {
    document.getElementById('mediaModal').style.display = 'none';
    clearModalInputs();
}

function switchTab(tabName) {
    // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event?.target?.classList.add('active') || document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    
    // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫ÂàáÊõø
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + 'Tab').classList.add('active');
}

function clearModalInputs() {
    document.getElementById('imageUrl').value = '';
    document.getElementById('imageAlt').value = '';
    document.getElementById('youtubeUrl').value = '';
    document.getElementById('twitterUrl').value = '';
    document.getElementById('externalUrl').value = '';
    document.getElementById('linkText').value = '';
    document.getElementById('movieSearch').value = '';
    selectedMovieId = null;
}

// ÁîªÂÉèÊåøÂÖ•
function insertImage() {
    const url = document.getElementById('imageUrl').value.trim();
    const alt = document.getElementById('imageAlt').value.trim();
    
    if (!url) {
        alert('ÁîªÂÉèURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const img = `<img src="${url}" alt="${alt}" style="max-width: 100%; height: auto; margin: 10px 0;">`;
    insertHTML(img);
    closeMediaModal();
}

// ÂãïÁîªÊåøÂÖ•
function insertVideo() {
    const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
    const twitterUrl = document.getElementById('twitterUrl').value.trim();
    
    let embed = '';
    
    if (youtubeUrl) {
        const videoId = extractYouTubeId(youtubeUrl);
        if (videoId) {
            embed = `<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; margin: 20px 0;">
                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                frameborder="0" allowfullscreen></iframe>
                     </div>`;
        }
    } else if (twitterUrl) {
        embed = `<div style="margin: 20px 0;">
                    <blockquote class="twitter-tweet">
                        <a href="${twitterUrl}"></a>
                    </blockquote>
                    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                 </div>`;
    }
    
    if (embed) {
        insertHTML(embed);
        closeMediaModal();
    } else {
        alert('ÊúâÂäπ„Å™URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    }
}

// „É™„É≥„ÇØÊåøÂÖ•
function insertLink() {
    const linkType = document.getElementById('linkType').value;
    
    let url = '';
    let text = '';
    
    if (linkType === 'external') {
        url = document.getElementById('externalUrl').value.trim();
        text = document.getElementById('linkText').value.trim();
    } else if (linkType === 'movie' && selectedMovieId) {
        url = `/movie/${selectedMovieId}`;
        text = document.getElementById('movieSearch').value.trim();
    }
    
    if (!url || !text) {
        alert('URL„Å®„É™„É≥„ÇØ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const link = `<a href="${url}" target="_blank">${text}</a>`;
    insertHTML(link);
    closeMediaModal();
}

// HTMLÊåøÂÖ•
function insertHTML(html) {
    const editor = document.getElementById('richEditor');
    editor.focus();
    
    if (window.getSelection) {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const div = document.createElement('div');
            div.innerHTML = html;
            const fragment = document.createDocumentFragment();
            let node;
            while ((node = div.firstChild)) {
                fragment.appendChild(node);
            }
            range.insertNode(fragment);
        }
    }
    
    updateHiddenFields();
}

// YouTube IDÊäΩÂá∫
function extractYouTubeId(url) {
    const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

// „É™„É≥„ÇØ„Ç™„Éó„Ç∑„Éß„É≥ÂàáÊõø
function toggleLinkOptions() {
    const linkType = document.getElementById('linkType').value;
    
    document.getElementById('externalLinkGroup').style.display = 
        linkType === 'external' ? 'block' : 'none';
    document.getElementById('movieLinkGroup').style.display = 
        linkType === 'movie' ? 'block' : 'none';
}

// Êò†ÁîªÊ§úÁ¥¢
document.getElementById('movieSearch').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        hideMovieSuggestions();
        return;
    }
    
    searchMovies(query);
});

function searchMovies(query) {
    // Á∞°ÊòìÊ§úÁ¥¢ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÊò†Áîª„Éá„Éº„Çø„Éô„Éº„ÇπAPI„Çí‰ΩøÁî®Ôºâ
    const movies = [
        { id: 1, title: 'ÂäáÂ†¥Áâà„ÄåÈ¨ºÊªÖ„ÅÆÂàÉ„ÄçÁÑ°ÈôêÂàóËªäÁ∑®', revenue: 404.3 },
        { id: 2, title: 'ÂçÉ„Å®ÂçÉÂ∞ã„ÅÆÁ•ûÈö†„Åó', revenue: 316.8 },
        { id: 3, title: 'Âêõ„ÅÆÂêç„ÅØ„ÄÇ', revenue: 251.7 }
    ];
    
    const filteredMovies = movies.filter(movie => 
        movie.title.toLowerCase().includes(query.toLowerCase())
    );
    
    showMovieSuggestions(filteredMovies);
}

function showMovieSuggestions(movies) {
    const suggestions = document.getElementById('movieSuggestions');
    
    if (movies.length === 0) {
        hideMovieSuggestions();
        return;
    }
    
    suggestions.innerHTML = movies.map(movie => `
        <div class="movie-suggestion" onclick="selectMovie(${movie.id}, '${movie.title}')">
            <span>${movie.title}</span>
            <span class="suggestion-revenue">${movie.revenue}ÂÑÑÂÜÜ</span>
        </div>
    `).join('');
    
    suggestions.style.display = 'block';
}

function hideMovieSuggestions() {
    document.getElementById('movieSuggestions').style.display = 'none';
}

function selectMovie(id, title) {
    selectedMovieId = id;
    document.getElementById('movieSearch').value = title;
    hideMovieSuggestions();
}

// „Çµ„É†„Éç„Ç§„É´Ê©üËÉΩ
document.getElementById('thumbnail_url').addEventListener('input', function() {
    updateThumbnailPreview(this.value);
});

function updateThumbnailPreview(url) {
    const preview = document.getElementById('thumbnailPreview');
    
    if (url.trim()) {
        preview.innerHTML = `
            <img src="${url}" alt="„Çµ„É†„Éç„Ç§„É´" onerror="showThumbnailError()">
            <button type="button" class="thumbnail-remove" onclick="removeThumbnail()">√ó</button>
        `;
    } else {
        preview.innerHTML = `
            <div class="thumbnail-placeholder">
                <div>„Éó„É¨„Éì„É•„Éº</div>
                <div style="font-size: 12px;">200√ó120</div>
            </div>
        `;
    }
}

function showThumbnailError() {
    const preview = document.getElementById('thumbnailPreview');
    preview.innerHTML = `
        <div class="thumbnail-placeholder" style="color: #f44336;">
            <div>ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº</div>
            <div style="font-size: 12px;">URL„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>
    `;
}

function removeThumbnail() {
    document.getElementById('thumbnail_url').value = '';
    updateThumbnailPreview('');
}

// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÔºà„Çµ„É†„Éç„Ç§„É´Ôºâ
const uploadArea = document.getElementById('thumbnailUpload');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleImageUpload(files[0]);
    }
});

uploadArea.addEventListener('click', function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        if (e.target.files.length > 0) {
            handleImageUpload(e.target.files[0]);
        }
    };
    input.click();
});

function handleImageUpload(file) {
    if (file.size > 5 * 1024 * 1024) {
        alert('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºàÊúÄÂ§ß5MBÔºâ');
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÁîªÂÉè„Çí„Çµ„Éº„Éê„Éº„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„ÄÅURL„ÇíÂèñÂæó
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('thumbnail_url').value = e.target.result;
        updateThumbnailPreview(e.target.result);
    };
    reader.readAsDataURL(file);
}

// „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ââç„ÅÆÂá¶ÁêÜ
document.querySelector('.article-form').addEventListener('submit', function(e) {
    updateHiddenFields();
    
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title || !content) {
        e.preventDefault();
        alert('„Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπ„ÅØÂøÖÈ†à„Åß„Åô');
        return false;
    }
});

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // „Ç®„Éá„Ç£„Çø„ÅÆÂàùÊúüÂÜÖÂÆπË®≠ÂÆö
    updateHiddenFields();
    
    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.getElementById('mediaModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeMediaModal();
        }
    });
    
    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
                case 'b':
                    e.preventDefault();
                    formatText('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    formatText('italic');
                    break;
                case 'u':
                    e.preventDefault();
                    formatText('underline');
                    break;
            }
        }
        
        if (e.key === 'Escape') {
            closeMediaModal();
        }
    });
});
</script>
{% endblock %}
