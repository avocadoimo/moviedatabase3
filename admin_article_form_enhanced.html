{% extends "base.html" %}

{% block title %}
{% if article %}è¨˜äº‹ç·¨é›†ï¼ˆå¼·åŒ–ç‰ˆï¼‰{% else %}æ–°è¦è¨˜äº‹ä½œæˆï¼ˆå¼·åŒ–ç‰ˆï¼‰{% endif %} - æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
{% endblock %}

{% block head %}
<style>
    .admin-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: var(--card-background);
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    .admin-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-success {
        background: var(--secondary-color);
        color: white;
    }

    .article-form {
        background: var(--card-background);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 30px;
    }

    .form-grid {
        display: grid;
        gap: 24px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
    }

    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: var(--transition);
        box-sizing: border-box;
        font-family: inherit;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    /* ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ */
    .rich-editor-container {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .rich-editor-toolbar {
        background: #f8f9fa;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .toolbar-btn {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .toolbar-btn:hover {
        background: #e9ecef;
    }

    .toolbar-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .toolbar-separator {
        width: 1px;
        background: #ddd;
        margin: 0 4px;
    }

    .rich-editor {
        min-height: 400px;
        padding: 16px;
        outline: none;
        font-size: 16px;
        line-height: 1.6;
        color: var(--text-color);
    }

    .rich-editor:focus {
        background: #fafbfc;
    }

    /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
    .image-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafbfc;
    }

    .image-upload-area:hover {
        border-color: var(--primary-color);
        background: #f0f7ff;
    }

    .image-upload-area.dragover {
        border-color: var(--primary-color);
        background: #e3f2fd;
    }

    .upload-icon {
        font-size: 48px;
        color: #999;
        margin-bottom: 16px;
    }

    .upload-text {
        font-size: 16px;
        color: #666;
        margin-bottom: 8px;
    }

    .upload-hint {
        font-size: 14px;
        color: #999;
    }

    /* ã‚µãƒ ãƒã‚¤ãƒ«è¨­å®š */
    .thumbnail-section {
        display: grid;
        grid-template-columns: 1fr 200px;
        gap: 20px;
        align-items: start;
    }

    .thumbnail-preview {
        width: 200px;
        height: 120px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        position: relative;
        overflow: hidden;
    }

    .thumbnail-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .thumbnail-placeholder {
        color: #999;
        font-size: 14px;
        text-align: center;
    }

    .thumbnail-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(244, 67, 54, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
    }

    /* ãƒ¡ãƒ‡ã‚£ã‚¢æŒ¿å…¥ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .media-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .media-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
    }

    .modal-tabs {
        display: flex;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }

    .modal-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        border-bottom: 2px solid transparent;
    }

    .modal-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* ãƒªãƒ³ã‚¯æŒ¿å…¥ */
    .link-section {
        display: grid;
        gap: 16px;
    }

    .movie-search-container {
        position: relative;
    }

    .movie-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
    }

    .movie-suggestion {
        padding: 10px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
    }

    .movie-suggestion:hover {
        background: #f8f9fa;
    }

    .suggestion-revenue {
        font-size: 12px;
        color: #666;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .error-message {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #d32f2f;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 767px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .thumbnail-section {
            grid-template-columns: 1fr;
        }
        
        .form-actions {
            flex-direction: column;
        }

        .rich-editor-toolbar {
            padding: 8px;
            gap: 4px;
        }

        .toolbar-btn {
            padding: 4px 8px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-title">
            {% if article %}âœï¸ è¨˜äº‹ç·¨é›†ï¼ˆå¼·åŒ–ç‰ˆï¼‰{% else %}â• æ–°è¦è¨˜äº‹ä½œæˆï¼ˆå¼·åŒ–ç‰ˆï¼‰{% endif %}
        </h1>
        <div class="admin-actions">
            <a href="{{ url_for('admin_articles') }}" class="btn btn-primary">
                ğŸ“‹ è¨˜äº‹ä¸€è¦§ã«æˆ»ã‚‹
            </a>
        </div>
    </div>

    {% if error %}
    <div class="error-message">
        {{ error }}
    </div>
    {% endif %}

    <form method="post" class="article-form" enctype="multipart/form-data">
        <div class="form-grid">
            <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="form-group">
                <label class="form-label" for="title">è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ« *</label>
                <input type="text" id="title" name="title" class="form-input" 
                       value="{{ article.title if article else (form_data.title if form_data else '') }}" 
                       required placeholder="æ˜ ç”»ã«é–¢ã™ã‚‹è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>

            <!-- åŸºæœ¬æƒ…å ± -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="author">ä½œæˆè€…</label>
                    <input type="text" id="author" name="author" class="form-input" 
                           value="{{ article.author if article else (form_data.author if form_data else '') }}" 
                           placeholder="è¨˜äº‹ã®ä½œæˆè€…å">
                </div>

                <div class="form-group">
                    <label class="form-label" for="category">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="category" name="category" class="form-select">
                        <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" 
                                {% if article and article.category == cat %}selected{% endif %}
                                {% if form_data and form_data.category == cat %}selected{% endif %}>
                            {{ cat }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- ã‚µãƒ ãƒã‚¤ãƒ«è¨­å®š -->
            <div class="form-group">
                <label class="form-label">ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ</label>
                <div class="thumbnail-section">
                    <div>
                        <input type="url" id="thumbnail_url" name="thumbnail_url" class="form-input" 
                               value="{{ article.thumbnail_url if article else (form_data.thumbnail_url if form_data else '') }}" 
                               placeholder="ç”»åƒURLã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸‹ã®ã‚¨ãƒªã‚¢ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—">
                        <div class="image-upload-area" id="thumbnailUpload">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                            <div class="upload-hint">JPG, PNG, GIF (æœ€å¤§5MB)</div>
                        </div>
                    </div>
                    <div class="thumbnail-preview" id="thumbnailPreview">
                        {% if article and article.thumbnail_url %}
                            <img src="{{ article.thumbnail_url }}" alt="ã‚µãƒ ãƒã‚¤ãƒ«">
                            <button type="button" class="thumbnail-remove" onclick="removeThumbnail()">Ã—</button>
                        {% else %}
                            <div class="thumbnail-placeholder">
                                <div>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                                <div style="font-size: 12px;">200Ã—120</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- è¨˜äº‹ã®æŠœç²‹ -->
            <div class="form-group">
                <label class="form-label" for="excerpt">è¨˜äº‹ã®æŠœç²‹</label>
                <textarea id="excerpt" name="excerpt" class="form-textarea" 
                          placeholder="è¨˜äº‹ã®è¦ç´„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºç™½ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ï¼‰">{{ article.excerpt if article else (form_data.excerpt if form_data else '') }}</textarea>
            </div>

            <!-- ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ -->
            <div class="form-group">
                <label class="form-label" for="content">è¨˜äº‹å†…å®¹ *</label>
                
                <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
                <div class="rich-editor-container">
                    <div class="rich-editor-toolbar">
                        <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="å¤ªå­—">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="æ–œä½“">
                            <em>I</em>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="ä¸‹ç·š">
                            <u>U</u>
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button type="button" class="toolbar-btn" onclick="formatText('formatBlock', 'h2')" title="è¦‹å‡ºã—2">
                            H2
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('formatBlock', 'h3')" title="è¦‹å‡ºã—3">
                            H3
                        </button>
                        <button type="button" class="toolbar-btn" onclick="formatText('formatBlock', 'p')" title="æ®µè½">
                            P
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button type="button" class="toolbar-btn" onclick="insertList('ul')" title="ç®‡æ¡æ›¸ã">
                            â—
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertList('ol')" title="ç•ªå·ä»˜ããƒªã‚¹ãƒˆ">
                            1.
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button type="button" class="toolbar-btn" onclick="openMediaModal('image')" title="ç”»åƒæŒ¿å…¥">
                            ğŸ“·
                        </button>
                        <button type="button" class="toolbar-btn" onclick="openMediaModal('video')" title="å‹•ç”»æŒ¿å…¥">
                            ğŸ¬
                        </button>
                        <button type="button" class="toolbar-btn" onclick="openMediaModal('link')" title="ãƒªãƒ³ã‚¯æŒ¿å…¥">
                            ğŸ”—
                        </button>
                    </div>
                    
                    <!-- ã‚¨ãƒ‡ã‚£ã‚¿æœ¬ä½“ -->
                    <div id="richEditor" class="rich-editor" contenteditable="true">
                        {{ article.content_html if article and article.content_html else (article.content.replace('\n', '<br>') if article else '') }}
                    </div>
                </div>
                
                <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <textarea id="content" name="content" style="display: none;" required>{{ article.content if article else (form_data.content if form_data else '') }}</textarea>
                <textarea id="content_html" name="content_html" style="display: none;">{{ article.content_html if article else (form_data.content_html if form_data else '') }}</textarea>
            </div>

            <!-- ã‚¿ã‚° -->
            <div class="form-group">
                <label class="form-label" for="tags">ã‚¿ã‚°</label>
                <input type="text" id="tags" name="tags" class="form-input" 
                       value="{{ article.tags if article else (form_data.tags if form_data else '') }}" 
                       placeholder="ã‚¿ã‚°ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆä¾‹: ã‚¢ãƒ‹ãƒ¡,èˆˆè¡Œåå…¥,ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰">
            </div>

            <!-- æ³¨ç›®è¨˜äº‹è¨­å®š -->
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="is_featured" name="is_featured" 
                           {% if article and article.is_featured %}checked{% endif %}
                           {% if form_data and form_data.is_featured %}checked{% endif %}>
                    â­ æ³¨ç›®è¨˜äº‹ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹
                </label>
            </div>

            <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="form-actions">
                <a href="{{ url_for('admin_articles') }}" class="btn" style="background: #666; color: white;">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </a>
                <button type="submit" class="btn btn-success">
                    {% if article %}ğŸ’¾ è¨˜äº‹ã‚’æ›´æ–°{% else %}ğŸ“ è¨˜äº‹ã‚’ä½œæˆ{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ãƒ¡ãƒ‡ã‚£ã‚¢æŒ¿å…¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="mediaModal" class="media-modal">
    <div class="media-modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’æŒ¿å…¥</h3>
            <button type="button" class="modal-close" onclick="closeMediaModal()">Ã—</button>
        </div>
        
        <div class="modal-tabs">
            <button type="button" class="modal-tab active" onclick="switchTab('image')">ç”»åƒ</button>
            <button type="button" class="modal-tab" onclick="switchTab('video')">å‹•ç”»</button>
            <button type="button" class="modal-tab" onclick="switchTab('link')">ãƒªãƒ³ã‚¯</button>
        </div>
        
        <!-- ç”»åƒæŒ¿å…¥ã‚¿ãƒ– -->
        <div id="imageTab" class="tab-content active">
            <div class="form-group">
                <label class="form-label">ç”»åƒURL</label>
                <input type="url" id="imageUrl" class="form-input" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label class="form-label">ä»£æ›¿ãƒ†ã‚­ã‚¹ãƒˆ</label>
                <input type="text" id="imageAlt" class="form-input" placeholder="ç”»åƒã®èª¬æ˜">
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn btn-primary" onclick="insertImage()">ç”»åƒã‚’æŒ¿å…¥</button>
            </div>
        </div>
        
        <!-- å‹•ç”»æŒ¿å…¥ã‚¿ãƒ– -->
        <div id="videoTab" class="tab-content">
            <div class="form-group">
                <label class="form-label">YouTube URL</label>
                <input type="url" id="youtubeUrl" class="form-input" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label class="form-label">Twitter/X ãƒã‚¹ãƒˆURL</label>
                <input type="url" id="twitterUrl" class="form-input" placeholder="https://twitter.com/user/status/...">
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn btn-primary" onclick="insertVideo()">å‹•ç”»ã‚’æŒ¿å…¥</button>
            </div>
        </div>
        
        <!-- ãƒªãƒ³ã‚¯æŒ¿å…¥ã‚¿ãƒ– -->
        <div id="linkTab" class="tab-content">
            <div class="form-group">
                <label class="form-label">ãƒªãƒ³ã‚¯ç¨®åˆ¥</label>
                <select id="linkType" class="form-select" onchange="toggleLinkOptions()">
                    <option value="external">å¤–éƒ¨ãƒªãƒ³ã‚¯</option>
                    <option value="movie">ä½œå“è©³ç´°ãƒšãƒ¼ã‚¸</option>
                    <option value="article">è¨˜äº‹ãƒšãƒ¼ã‚¸</option>
                </select>
            </div>
            
            <!-- å¤–éƒ¨ãƒªãƒ³ã‚¯ -->
            <div id="externalLinkGroup">
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" id="externalUrl" class="form-input" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ</label>
                    <input type="text" id="linkText" class="form-input" placeholder="ãƒªãƒ³ã‚¯ã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ">
                </div>
            </div>
            
            <!-- ä½œå“ãƒªãƒ³ã‚¯ -->
            <div id="movieLinkGroup" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ä½œå“ã‚’æ¤œç´¢</label>
                    <div class="movie-search-container">
                        <input type="text" id="movieSearch" class="form-input" placeholder="æ˜ ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" autocomplete="off">
                        <div id="movieSuggestions" class="movie-suggestions"></div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: right;">
                <button type="button" class="btn btn-primary" onclick="insertLink()">ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedMovieId = null;

// ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®æ©Ÿèƒ½
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    updateHiddenFields();
}

function insertList(type) {
    const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
    document.execCommand(command, false, null);
    updateHiddenFields();
}

// ã‚¨ãƒ‡ã‚£ã‚¿å†…å®¹ã®æ›´æ–°
function updateHiddenFields() {
    const editor = document.getElementById('richEditor');
    const htmlContent = editor.innerHTML;
    const textContent = editor.innerText;
    
    document.getElementById('content_html').value = htmlContent;
    document.getElementById('content').value = textContent;
}

// ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('richEditor').addEventListener('input', updateHiddenFields);
document.getElementById('richEditor').addEventListener('paste', function(e) {
    setTimeout(updateHiddenFields, 100);
});

// ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ«
function openMediaModal(type) {
    document.getElementById('mediaModal').style.display = 'block';
    switchTab(type);
    
    const titles = {
        'image': 'ç”»åƒã‚’æŒ¿å…¥',
        'video': 'å‹•ç”»ã‚’æŒ¿å…¥', 
        'link': 'ãƒªãƒ³ã‚¯ã‚’æŒ¿å…¥'
    };
    
    document.getElementById('modalTitle').textContent = titles[type] || 'ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’æŒ¿å…¥';
}

function closeMediaModal() {
    document.getElementById('mediaModal').style.display = 'none';
    clearModalInputs();
}

function switchTab(tabName) {
    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event?.target?.classList.add('active') || document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
    
    // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡æ›¿
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + 'Tab').classList.add('active');
}

function clearModalInputs() {
    document.getElementById('imageUrl').value = '';
    document.getElementById('imageAlt').value = '';
    document.getElementById('youtubeUrl').value = '';
    document.getElementById('twitterUrl').value = '';
    document.getElementById('externalUrl').value = '';
    document.getElementById('linkText').value = '';
    document.getElementById('movieSearch').value = '';
    selectedMovieId = null;
}

// ç”»åƒæŒ¿å…¥
function insertImage() {
    const url = document.getElementById('imageUrl').value.trim();
    const alt = document.getElementById('imageAlt').value.trim();
    
    if (!url) {
        alert('ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const img = `<img src="${url}" alt="${alt}" style="max-width: 100%; height: auto; margin: 10px 0;">`;
    insertHTML(img);
    closeMediaModal();
}

// å‹•ç”»æŒ¿å…¥
function insertVideo() {
    const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
    const twitterUrl = document.getElementById('twitterUrl').value.trim();
    
    let embed = '';
    
    if (youtubeUrl) {
        const videoId = extractYouTubeId(youtubeUrl);
        if (videoId) {
            embed = `<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; margin: 20px 0;">
                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                frameborder="0" allowfullscreen></iframe>
                     </div>`;
        }
    } else if (twitterUrl) {
        embed = `<div style="margin: 20px 0;">
                    <blockquote class="twitter-tweet">
                        <a href="${twitterUrl}"></a>
                    </blockquote>
                    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                 </div>`;
    }
    
    if (embed) {
        insertHTML(embed);
        closeMediaModal();
    } else {
        alert('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
}

// ãƒªãƒ³ã‚¯æŒ¿å…¥
function insertLink() {
    const linkType = document.getElementById('linkType').value;
    
    let url = '';
    let text = '';
    
    if (linkType === 'external') {
        url = document.getElementById('externalUrl').value.trim();
        text = document.getElementById('linkText').value.trim();
    } else if (linkType === 'movie' && selectedMovieId) {
        url = `/movie/${selectedMovieId}`;
        text = document.getElementById('movieSearch').value.trim();
    }
    
    if (!url || !text) {
        alert('URLã¨ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    const link = `<a href="${url}" target="_blank">${text}</a>`;
    insertHTML(link);
    closeMediaModal();
}

// HTMLæŒ¿å…¥
function insertHTML(html) {
    const editor = document.getElementById('richEditor');
    editor.focus();
    
    if (window.getSelection) {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const div = document.createElement('div');
            div.innerHTML = html;
            const fragment = document.createDocumentFragment();
            let node;
            while ((node = div.firstChild)) {
                fragment.appendChild(node);
            }
            range.insertNode(fragment);
        }
    }
    
    updateHiddenFields();
}

// YouTube IDæŠ½å‡º
function extractYouTubeId(url) {
    const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

// ãƒªãƒ³ã‚¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆ‡æ›¿
function toggleLinkOptions() {
    const linkType = document.getElementById('linkType').value;
    
    document.getElementById('externalLinkGroup').style.display = 
        linkType === 'external' ? 'block' : 'none';
    document.getElementById('movieLinkGroup').style.display = 
        linkType === 'movie' ? 'block' : 'none';
}

// æ˜ ç”»æ¤œç´¢
document.getElementById('movieSearch').addEventListener('input', function() {
    const query = this.value.trim();
    if (query.length < 2) {
        hideMovieSuggestions();
        return;
    }
    
    searchMovies(query);
});

function searchMovies(query) {
    // ç°¡æ˜“æ¤œç´¢ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹APIã‚’ä½¿ç”¨ï¼‰
    const movies = [
        { id: 1, title: 'åŠ‡å ´ç‰ˆã€Œé¬¼æ»…ã®åˆƒã€ç„¡é™åˆ—è»Šç·¨', revenue: 404.3 },
        { id: 2, title: 'åƒã¨åƒå°‹ã®ç¥éš ã—', revenue: 316.8 },
        { id: 3, title: 'å›ã®åã¯ã€‚', revenue: 251.7 }
    ];
    
    const filteredMovies = movies.filter(movie => 
        movie.title.toLowerCase().includes(query.toLowerCase())
    );
    
    showMovieSuggestions(filteredMovies);
}

function showMovieSuggestions(movies) {
    const suggestions = document.getElementById('movieSuggestions');
    
    if (movies.length === 0) {
        hideMovieSuggestions();
        return;
    }
    
    suggestions.innerHTML = movies.map(movie => `
        <div class="movie-suggestion" onclick="selectMovie(${movie.id}, '${movie.title}')">
            <span>${movie.title}</span>
            <span class="suggestion-revenue">${movie.revenue}å„„å††</span>
        </div>
    `).join('');
    
    suggestions.style.display = 'block';
}

function hideMovieSuggestions() {
    document.getElementById('movieSuggestions').style.display = 'none';
}

function selectMovie(id, title) {
    selectedMovieId = id;
    document.getElementById('movieSearch').value = title;
    hideMovieSuggestions();
}

// ã‚µãƒ ãƒã‚¤ãƒ«æ©Ÿèƒ½
document.getElementById('thumbnail_url').addEventListener('input', function() {
    updateThumbnailPreview(this.value);
});

function updateThumbnailPreview(url) {
    const preview = document.getElementById('thumbnailPreview');
    
    if (url.trim()) {
        preview.innerHTML = `
            <img src="${url}" alt="ã‚µãƒ ãƒã‚¤ãƒ«" onerror="showThumbnailError()">
            <button type="button" class="thumbnail-remove" onclick="removeThumbnail()">Ã—</button>
        `;
    } else {
        preview.innerHTML = `
            <div class="thumbnail-placeholder">
                <div>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div style="font-size: 12px;">200Ã—120</div>
            </div>
        `;
    }
}

function showThumbnailError() {
    const preview = document.getElementById('thumbnailPreview');
    preview.innerHTML = `
        <div class="thumbnail-placeholder" style="color: #f44336;">
            <div>ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>
            <div style="font-size: 12px;">URLã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
        </div>
    `;
}

function removeThumbnail() {
    document.getElementById('thumbnail_url').value = '';
    updateThumbnailPreview('');
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ï¼‰
const uploadArea = document.getElementById('thumbnailUpload');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleImageUpload(files[0]);
    }
});

uploadArea.addEventListener('click', function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        if (e.target.files.length > 0) {
            handleImageUpload(e.target.files[0]);
        }
    };
    input.click();
});

function handleImageUpload(file) {
    if (file.size > 5 * 1024 * 1024) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§5MBï¼‰');
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€URLã‚’å–å¾—
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('thumbnail_url').value = e.target.result;
        updateThumbnailPreview(e.target.result);
    };
    reader.readAsDataURL(file);
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®å‡¦ç†
document.querySelector('.article-form').addEventListener('submit', function(e) {
    updateHiddenFields();
    
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title || !content) {
        e.preventDefault();
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã¯å¿…é ˆã§ã™');
        return false;
    }
});

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆæœŸå†…å®¹è¨­å®š
    updateHiddenFields();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('mediaModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeMediaModal();
        }
    });
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
                case 'b':
                    e.preventDefault();
                    formatText('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    formatText('italic');
                    break;
                case 'u':
                    e.preventDefault();
                    formatText('underline');
                    break;
            }
        }
        
        if (e.key === 'Escape') {
            closeMediaModal();
        }
    });
});
</script>
{% endblock %}
